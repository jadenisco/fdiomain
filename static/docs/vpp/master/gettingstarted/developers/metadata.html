

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Buffer Metadata &mdash; Vector Packet Processor 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Multi-architecture support" href="multiarch/index.html" />
    <link rel="prev" title="Feature Arcs" href="featurearcs.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Vector Packet Processor
          

          
            
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../users/index.html">For Users</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">For Developers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="building.html">Building VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_vpp.html">Running VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="gdb_examples.html">GDB Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="add_plugin.html">Adding a plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l3"><a class="reference internal" href="softwarearchitecture.html">Software Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure.html">VPPINFRA (Infrastructure)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vlib.html">VLIB (Vector Processing Library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="vnet.html">VNET (VPP Network Stack)</a></li>
<li class="toctree-l3"><a class="reference internal" href="featurearcs.html">Feature Arcs</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Buffer Metadata</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vlib-vector-library-primary-buffer-metatdata">Vlib (Vector library) primary buffer metatdata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vnet-network-stack-primary-buffer-metadata">Vnet (network stack) primary buffer metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vnet-network-stack-secondary-buffer-metatdata">Vnet (network stack) secondary buffer metatdata</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#buffer-metadata-extensions">Buffer Metadata Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="multiarch/index.html">Multi-architecture support</a></li>
<li class="toctree-l3"><a class="reference internal" href="bihash.html">Bounded-index Extensible Hashing (bihash)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vpp_api_module.html">VPP API module</a></li>
<li class="toctree-l3"><a class="reference internal" href="binary_api_support.html">Binary API Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildsystem/index.html">Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="eventviewer.html">Event-logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="eventviewer.html#g2-graphical-event-viewer">G2 graphical event viewer</a></li>
<li class="toctree-l3"><a class="reference internal" href="fib20/index.html">FIB 2.0 Hierarchical, Protocol, Independent</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildwireshark.html">How to build a vpp dispatch trace aware Wireshark</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../writingdocs/index.html">Writing Documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../featuresbyrelease/index.html">Features by Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relatedprojects/index.html">Related Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/index.html">Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="index.html">For Developers</a> &raquo;</li>
        
      <li>Buffer Metadata</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/gettingstarted/developers/metadata.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="buffer-metadata">
<span id="buffer-metadata"></span><h1>Buffer Metadata<a class="headerlink" href="#buffer-metadata" title="Permalink to this headline">¶</a></h1>
<p>Each vlib_buffer_t (packet buffer) carries buffer metadata which
describes the current packet-processing state. The underlying
techniques have been used for decades, across multiple packet
processing environments.</p>
<p>We will examine vpp buffer metadata in some detail, but folks who need
to manipulate and/or extend the scheme should expect to do a certain
level of code inspection.</p>
<div class="section" id="vlib-vector-library-primary-buffer-metatdata">
<span id="vlib-vector-library-primary-buffer-metatdata"></span><h2>Vlib (Vector library) primary buffer metatdata<a class="headerlink" href="#vlib-vector-library-primary-buffer-metatdata" title="Permalink to this headline">¶</a></h2>
<p>The first 64 octets of each vlib_buffer_t carries the primary buffer
metadata. See …/src/vlib/buffer.h for full details.</p>
<p>Important fields:</p>
<ul class="simple">
<li>i16 current_data: the signed offset in data[], pre_data[] that we
are currently processing. If negative current header points into
the pre-data (rewrite space) area.</li>
<li>u16 current_length: nBytes between current_data and the end of this buffer.</li>
<li>u32 flags: Buffer flag bits. Heavily used, not many bits left<ul>
<li>src/vlib/buffer.h flag bits<ul>
<li>VLIB_BUFFER_IS_TRACED: buffer is traced</li>
<li>VLIB_BUFFER_NEXT_PRESENT: buffer has multiple chunks</li>
<li>VLIB_BUFFER_TOTAL_LENGTH_VALID: total_length_not_including_first_buffer is valid (see below)</li>
</ul>
</li>
<li>src/vnet/buffer.h flag bits<ul>
<li>VNET_BUFFER_F_L4_CHECKSUM_COMPUTED: tcp/udp checksum has been computed</li>
<li>VNET_BUFFER_F_L4_CHECKSUM_CORRECT: tcp/udp checksum is correct</li>
<li>VNET_BUFFER_F_VLAN_2_DEEP: two vlan tags present</li>
<li>VNET_BUFFER_F_VLAN_1_DEEP: one vlag tag present</li>
<li>VNET_BUFFER_F_SPAN_CLONE: packet has already been cloned (span feature)</li>
<li>VNET_BUFFER_F_LOOP_COUNTER_VALID: packet look-up loop count valid</li>
<li>VNET_BUFFER_F_LOCALLY_ORIGINATED: packet built by vpp</li>
<li>VNET_BUFFER_F_IS_IP4: packet is ipv4, for checksum offload</li>
<li>VNET_BUFFER_F_IS_IP6: packet is ipv6, for checksum offload</li>
<li>VNET_BUFFER_F_OFFLOAD_IP_CKSUM: hardware ip checksum offload requested</li>
<li>VNET_BUFFER_F_OFFLOAD_TCP_CKSUM: hardware tcp checksum offload requested</li>
<li>VNET_BUFFER_F_OFFLOAD_UDP_CKSUM: hardware udp checksum offload requested</li>
<li>VNET_BUFFER_F_IS_NATED: natted packet, skip input checks</li>
<li>VNET_BUFFER_F_L2_HDR_OFFSET_VALID: L2 header offset valid</li>
<li>VNET_BUFFER_F_L3_HDR_OFFSET_VALID: L3 header offset valid</li>
<li>VNET_BUFFER_F_L4_HDR_OFFSET_VALID: L4 header offset valid</li>
<li>VNET_BUFFER_F_FLOW_REPORT: packet is an ipfix packet</li>
<li>VNET_BUFFER_F_IS_DVR: packet to be reinjected into the l2 output path</li>
<li>VNET_BUFFER_F_QOS_DATA_VALID: QoS data valid in vnet_buffer_opaque2</li>
<li>VNET_BUFFER_F_GSO: generic segmentation offload requested</li>
<li>VNET_BUFFER_F_AVAIL1: avaliable bit</li>
<li>VNET_BUFFER_F_AVAIL2: avaliable bit</li>
<li>VNET_BUFFER_F_AVAIL3: avaliable bit</li>
<li>VNET_BUFFER_F_AVAIL4: avaliable bit</li>
<li>VNET_BUFFER_F_AVAIL5: avaliable bit</li>
<li>VNET_BUFFER_F_AVAIL6: avaliable bit</li>
<li>VNET_BUFFER_F_AVAIL7: avaliable bit</li>
</ul>
</li>
</ul>
</li>
<li>u32 flow_id: generic flow identifier</li>
<li>u8 ref_count: buffer reference / clone count (e.g. for span replication)</li>
<li>u8 buffer_pool_index: buffer pool index which owns this buffer</li>
<li>vlib_error_t (u16) error: error code for buffers enqueued to error handler</li>
<li>u32 next_buffer: buffer index of next buffer in chain. Only valid if VLIB_BUFFER_NEXT_PRESENT is set</li>
<li>union<ul>
<li>u32 current_config_index: current index on feature arc</li>
<li>u32 punt_reason: reason code once packet punted. Mutually exclusive with current_config_index</li>
</ul>
</li>
<li>u32 opaque[10]: primary vnet-layer opaque data (see below)</li>
<li>END of first cache line / data initialized by the buffer allocator</li>
<li>u32 trace_index: buffer’s index in the packet trace subsystem</li>
<li>u32 total_length_not_including_first_buffer: see VLIB_BUFFER_TOTAL_LENGTH_VALID above</li>
<li>u32 opaque2[14]: secondary vnet-layer opaque data (see below)</li>
<li>u8 pre_data[VLIB_BUFFER_PRE_DATA_SIZE]: rewrite space, often used to prepend tunnel encapsulations</li>
<li>u8 data[0]: buffer data received from the wire. Ordinarily, hardware devices use b-&gt;data[0] as the DMA target but there are exceptions. Do not write code which blindly assumes that packet data starts in b-&gt;data[0]. Use vlib_buffer_get_current(…).</li>
</ul>
</div>
<div class="section" id="vnet-network-stack-primary-buffer-metadata">
<span id="vnet-network-stack-primary-buffer-metadata"></span><h2>Vnet (network stack) primary buffer metadata<a class="headerlink" href="#vnet-network-stack-primary-buffer-metadata" title="Permalink to this headline">¶</a></h2>
<p>Vnet primary buffer metadata occupies space reserved in the vlib
opaque field shown above, and has the type name
vnet_buffer_opaque_t. Ordinarily accessed using the vnet_buffer(b)
macro. See ../src/vnet/buffer.h for full details.</p>
<p>Important fields:</p>
<ul class="simple">
<li>u32 sw_if_index[2]: RX and TX interface handles. At the ip lookup
stage, vnet_buffer(b)-&gt;sw_if_index[VLIB_TX] is interpreted as a FIB
index.</li>
<li>i16 l2_hdr_offset: offset from b-&gt;data[0] of the packet L2 header.
Valid only if b-&gt;flags &amp; VNET_BUFFER_F_L2_HDR_OFFSET_VALID is set</li>
<li>i16 l3_hdr_offset: offset from b-&gt;data[0] of the packet L3 header.
Valid only if b-&gt;flags &amp; VNET_BUFFER_F_L3_HDR_OFFSET_VALID is set</li>
<li>i16 l4_hdr_offset: offset from b-&gt;data[0] of the packet L4 header.
Valid only if b-&gt;flags &amp; VNET_BUFFER_F_L4_HDR_OFFSET_VALID is set</li>
<li>u8 feature_arc_index: feature arc that the packet is currently traversing</li>
<li>union<ul>
<li>ip<ul>
<li>u32 adj_index[2]: adjacency from dest IP lookup in [VLIB_TX], adjacency
from source ip lookup in [VLIB_RX], set to ~0 until source lookup done</li>
<li>union<ul>
<li>generic fields</li>
<li>ICMP fields</li>
<li>reassembly fields</li>
</ul>
</li>
</ul>
</li>
<li>mpls fields</li>
<li>l2 bridging fields, only valid in the L2 path</li>
<li>l2tpv3 fields</li>
<li>l2 classify fields</li>
<li>vnet policer fields</li>
<li>MAP fields</li>
<li>MAP-T fields</li>
<li>ip fragmentation fields</li>
<li>COP (whitelist/blacklist filter) fields</li>
<li>LISP fields</li>
<li>TCP fields<ul>
<li>connection index</li>
<li>sequence numbers</li>
<li>header and data offsets</li>
<li>data length</li>
<li>flags</li>
</ul>
</li>
<li>SCTP fields</li>
<li>NAT fields</li>
<li>u32 unused[6]</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="vnet-network-stack-secondary-buffer-metatdata">
<span id="vnet-network-stack-secondary-buffer-metatdata"></span><h2>Vnet (network stack) secondary buffer metatdata<a class="headerlink" href="#vnet-network-stack-secondary-buffer-metatdata" title="Permalink to this headline">¶</a></h2>
<p>Vnet primary buffer metadata occupies space reserved in the vlib
opaque2 field shown above, and has the type name
vnet_buffer_opaque2_t. Ordinarily accessed using the vnet_buffer2(b)
macro. See ../src/vnet/buffer.h for full details.</p>
<p>Important fields:</p>
<ul class="simple">
<li>qos fields<ul>
<li>u8 bits</li>
<li>u8 source</li>
</ul>
</li>
<li>u8 loop_counter: used to detect and report internal forwarding loops</li>
<li>group-based policy fields<ul>
<li>u8 flags</li>
<li>u16 sclass: the packet’s source class</li>
</ul>
</li>
<li>u16 gso_size: L4 payload size, persists all the way to
interface-output in case GSO is not enabled</li>
<li>u16 gso_l4_hdr_sz: size of the L4 protocol header</li>
<li>union<ul>
<li>packet trajectory tracer (largely deprecated)<ul>
<li>u16 *trajectory_trace; only #if VLIB_BUFFER_TRACE_TRAJECTORY &gt; 0</li>
</ul>
</li>
<li>packet generator<ul>
<li>u64 pg_replay_timestamp: timestamp for replayed pcap trace packets</li>
</ul>
</li>
<li>u32 unused[8]</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="buffer-metadata-extensions">
<span id="buffer-metadata-extensions"></span><h1>Buffer Metadata Extensions<a class="headerlink" href="#buffer-metadata-extensions" title="Permalink to this headline">¶</a></h1>
<p>Plugin developers may wish to extend either the primary or secondary
vnet buffer opaque unions. Please perform a
manual live variable analysis, otherwise nodes which use shared buffer metadata space may break things.</p>
<p>It’s not OK to add plugin or proprietary metadata to the core vpp
engine header files named above. Instead, proceed as follows. The
example concerns the vnet primary buffer opaque union
vlib_buffer_opaque_t. It’s a very simple variation to use the vnet
secondary buffer opaque union vlib_buffer_opaque2_t.</p>
<p>In a plugin header file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">/*</span> <span class="n">Add</span> <span class="n">arbitrary</span> <span class="n">buffer</span> <span class="n">metadata</span> <span class="o">*/</span>
    <span class="c1">#include &lt;vnet/buffer.h&gt;</span>

    <span class="n">typedef</span> <span class="n">struct</span>
    <span class="p">{</span>
      <span class="n">u32</span> <span class="n">my_stuff</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">my_buffer_opaque_t</span><span class="p">;</span>

    <span class="n">STATIC_ASSERT</span> <span class="p">(</span><span class="n">sizeof</span> <span class="p">(</span><span class="n">my_buffer_opaque_t</span><span class="p">)</span> <span class="o">&lt;=</span>
                   <span class="n">STRUCT_SIZE_OF</span> <span class="p">(</span><span class="n">vnet_buffer_opaque_t</span><span class="p">,</span> <span class="n">unused</span><span class="p">),</span>
                   <span class="s2">&quot;Custom meta-data too large for vnet_buffer_opaque_t&quot;</span><span class="p">);</span>

    <span class="c1">#define my_buffer_opaque(b)  \</span>
      <span class="p">((</span><span class="n">my_buffer_opaque_t</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)((</span><span class="n">b</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="p">)</span> <span class="o">+</span> <span class="n">STRUCT_OFFSET_OF</span> <span class="p">(</span><span class="n">vnet_buffer_opaque_t</span><span class="p">,</span> <span class="n">unused</span><span class="p">)))</span>
</pre></div>
</div>
<p>To set data in the custom buffer opaque type given a vlib_buffer_t *b:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">my_buffer_opaque</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">my_stuff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
</pre></div>
</div>
<p>To read data from the custom buffer opaque type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">stuff0</span> <span class="o">=</span> <span class="n">my_buffer_opaque</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">my_stuff</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="multiarch/index.html" class="btn btn-neutral float-right" title="Multi-architecture support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="featurearcs.html" class="btn btn-neutral" title="Feature Arcs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>